# CatMusic 三大核心模块技术文档

## 一、整体架构概述

```plantuml
@startuml
package "CatMusic" {
    [专辑列表] as AlbumList
    [歌曲列表] as SongList
    [播放器] as Player
    
    AlbumList --> SongList : 点击专辑
    SongList --> Player : 点击歌曲
    Player --> SongList : 返回/切换
    Player --> AlbumList : 返回
}
@enduml
```

## 二、专辑列表模块

### 开发思路流程

```plantuml
@startuml
start
:应用启动;
:初始化AlbumsRecyclerViewAdapter;
:发送网络请求获取专辑列表;
if (请求成功?) then (是)
    :解析专辑数据;
    :更新RecyclerView适配器;
    :使用Glide加载专辑封面;
    :展示专辑列表;
else (否)
    :显示错误提示;
endif
:用户点击专辑;
:跳转到歌曲列表模块;
stop
@enduml
```

## 三、歌曲列表模块

### 开发思路流程

```plantuml
@startuml
start
:从Intent获取专辑信息;
:初始化SongListActivity;
:发送网络请求获取歌曲列表;
if (请求成功?) then (是)
    :解析歌曲数据;
    :更新SongsRecyclerViewAdapter;
    :展示歌曲列表;
else (否)
    :显示错误提示;
endif
:用户点击歌曲;
:构建歌曲列表数据;
:跳转到播放器模块;
stop
@enduml
```

## 四、播放器模块

### 开发思路流程

```plantuml
@startuml
start
:从Intent获取歌曲列表和当前位置;
:初始化PlayerActivity;
:启动并绑定MusicService;
:ServiceConnection回调获取MusicService实例;
:设置歌曲列表和当前位置;
:调用MusicService.playMusic();
:初始化MediaPlayer;
:设置MediaPlayer数据源;
:准备播放;
if (准备成功?) then (是)
    :开始播放音乐;
    :启动进度条更新任务;
    :启动歌词同步任务;
    :开始专辑封面旋转动画;
else (否)
    :显示播放错误提示;
endif

note right: 播放过程中

:用户交互(播放/暂停/切换);
:调用MusicService相应方法;
:更新UI状态;

note right: 播放结束

:MediaPlayer回调onCompletion;
:根据播放模式处理;
:播放下一首/停止;
stop
@enduml
```

### 灵活的歌词解析

```plantuml
@startuml
start
:获取歌词字符串;
:清理歌词字符串(移除换行符);
:尝试匹配"歌词内容[时间戳]"格式;
if (匹配成功?) then (是)
    :解析时间戳和歌词内容;
    :添加到歌词列表;
else (否)
    :尝试匹配"[时间戳]歌词内容"格式;
    if (匹配成功?) then (是)
        :解析时间戳和歌词内容;
        :添加到歌词列表;
    else (否)
        :直接使用原始歌词内容;
    endif
endif
:返回解析后的歌词对象;
stop
@enduml
```

### 自定义 LyricView 设计

```plantuml
@startuml
start
:设置当前播放时间;
:计算当前歌词行索引;
:如果索引变化，触发重绘;
:绘制歌词行;
:计算每行歌词的位置;
:高亮显示当前行;
:根据距离中心的位置调整透明度;
:绘制歌词文本;
stop
@enduml
```

## 五、模块间协作流程

```plantuml
@startuml
actor 用户

用户 -> [专辑列表] : 打开应用
[专辑列表] -> [专辑列表] : 加载专辑数据
[专辑列表] -> 用户 : 显示专辑列表

用户 -> [专辑列表] : 点击专辑
[专辑列表] -> [歌曲列表] : 传递专辑信息
[歌曲列表] -> [歌曲列表] : 加载歌曲数据
[歌曲列表] -> 用户 : 显示歌曲列表

用户 -> [歌曲列表] : 点击歌曲
[歌曲列表] -> [播放器] : 传递歌曲列表和位置
[播放器] -> [播放器] : 初始化播放环境
[播放器] -> [播放器] : 开始播放音乐
[播放器] -> 用户 : 显示播放界面

用户 -> [播放器] : 操作播放控制
[播放器] -> [播放器] : 更新播放状态
[播放器] -> 用户 : 更新播放界面

用户 -> [播放器] : 返回
[播放器] -> [歌曲列表] : 返回歌曲列表

用户 -> [歌曲列表] : 返回
[歌曲列表] -> [专辑列表] : 返回专辑列表
@enduml
```

## 六、技术栈关系图

```plantuml
@startuml
title CatMusic 技术栈关系

package "专辑列表" {
    [RecyclerView]
    [Glide]
    [OkHttp]
}

package "歌曲列表" {
    [RecyclerView]
    [Glide]
    [OkHttp]
    [Gson]
}

package "播放器" {
    [MediaPlayer]
    [Service]
    [Binder]
    [自定义View]
    [Animation]
    [Glide]
    [OkHttp]
    [Gson]
}

[RecyclerView] --> "专辑列表"
[Glide] --> "专辑列表"
[OkHttp] --> "专辑列表"

[RecyclerView] --> "歌曲列表"
[Glide] --> "歌曲列表"
[OkHttp] --> "歌曲列表"
[Gson] --> "歌曲列表"

[MediaPlayer] --> "播放器"
[Service] --> "播放器"
[Binder] --> "播放器"
[自定义View] --> "播放器"
[Animation] --> "播放器"
[Glide] --> "播放器"
[OkHttp] --> "播放器"
[Gson] --> "播放器"
@enduml
```

## 七、核心技术实现流程图

### 7.1 Service通信流程

```plantuml
@startuml
title 播放器模块 - Service通信流程

actor PlayerActivity
participant "ServiceConnection" as Connection
participant "MusicService.MusicBinder" as Binder
participant "MusicService" as Service

PlayerActivity -> Connection : bindService()
Connection -> Binder : onServiceConnected()
Binder -> Service : getService()
Service --> Binder : 返回Service实例
Binder --> Connection : 返回Binder实例
Connection --> PlayerActivity : 返回Service实例
PlayerActivity -> Service : 调用playMusic()
Service -> Service : 初始化MediaPlayer
Service -> Service : 开始播放
Service --> PlayerActivity : 播放状态回调
@enduml
```

### 7.2 专辑封面动画流程

```plantuml
@startuml
title 播放器模块 - 专辑封面动画流程

start
:初始化RotateAnimation;
:设置动画参数(15秒/圈, 线性插值);
:音乐开始播放;
:启动旋转动画;
:音乐暂停;
:暂停旋转动画;
:音乐继续播放;
:恢复旋转动画;
:音乐停止;
:停止旋转动画;
stop
@enduml
```

## 八、技术亮点与创新点

### 8.1 灵活的歌词解析

```plantuml
@startuml
title 歌词解析创新点

start
:支持标准格式 [mm:ss.xx]歌词;
:支持非标准格式 歌词[mm:ss.xx];
:自动清理歌词字符串;
:容错处理格式错误;
:返回结构化歌词对象;
stop
@enduml
```

### 8.2 自定义LyricView设计

```plantuml
@startuml
title 自定义LyricView创新点

start
:实时同步播放进度;
:流畅的滚动效果;
:当前行高亮显示;
:透明度渐变效果;
:支持多种歌词格式;
stop
@enduml
```

## 九、未来优化方向

```plantuml
@startuml
title CatMusic 未来优化方向

start
:性能优化;
:功能扩展;
:UI/UX优化;
:兼容性改进;
:代码重构;
:测试完善;
stop
@enduml
```
